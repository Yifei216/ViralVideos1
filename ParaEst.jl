# Filename: ParaEst.jl
# Author: Yifei Li, Li Shao
# Harbin institute of Technology, Harbin, China, May 2024
# Reference:  Y. Li, L. Shao (2024) 
# The script contains the parameter estimation algorithm

using DifferentialEquations
using Plots
using Optim

#ODE model
function SIR(dy,y,para,t)
    beta,beta1,alpha,gamma,b,N=para
    S,I,R=y
    dy[1] = -beta*S*I/N-N^2*gamma/(N+I)+b*N
    dy[2] = beta1*S*I/N+N^2*gamma/(N+I)-alpha*I
    dy[3] = (beta-beta1)*S*I/N+alpha*I
end

#calculating the cost function 
function ParameterEstimater_SIR(ini)
    global Data_Sum
    S0=2e9
    I0=100
    R0=Data_Sum[1]
    
    #for Caroline and Cheap Thrill with 425 time steps
    tspan = (0.0,424.0)
    #for All about that bass with 955 time steps
    #tspan = (0.0,944.0)

    u0=[S0 I0 R0]

    para=[ini sum(u0)]

    prob = ODEProblem(SIR,u0,tspan,para)

    sol = solve(prob,DP5(),reltol=1e-8,abstol=1e-8,saveat = 1)

    S=Array{Float64}(undef, length(sol.t))
    I=Array{Float64}(undef, length(sol.t))
    R=Array{Float64}(undef, length(sol.t))

    for i=1:length(sol.t)
        S[i]=sol.u[i][1]
        I[i]=sol.u[i][2]
        R[i]=sol.u[i][3]
    end
    

    if length(R)!=length(Data_Sum)
        return 1
    else
        return sum((R'-Data_Sum).^2)/(maximum(Data_Sum)^2*tspan[end])
    end
end

#Data for three songs
#Caroline
A=[2753	2603 8114	5549	4071	5272	12011	13805	16633	16280	19399	22791	23297	19272	13326	17914	32777	26845	37904	56257	51885	32761	30153	35610	38411	32883	33037	29976	30086	35938	35804	35791	35794	35875	38609	40283	36153	35770	35788	35791	36855	40722	41312	41298	41297	41301	41380	44127	47111	46815	46631	48034	46803	46622	51704	58220	63508	63205	66177	63041	60574	67323	74059	74743	79711	82594	82361	85482	85343	85352	85378	88375	87820	90859	87595	93142	96707	102011	101866	108373	113099	104355	101656	104518	111525	114604	121453	132466	127528	128660	155335	176200	187818	206846	232014	228411	215159	202961	211629	215013	233408	262621	270386	231998	242275	249729	247990	257372	281386	281763	250509	237790	245485	254099	273158	306191	323969	297336	279572	277978	291534	294177	315835	321098	294101	283559	299184	326168	358954	389808	385435	362093	371901	375232	376406	389693	448698	425580	384573	382083	395717	419283	467930	540477	515002	461486	446697	453814	475047	523538	580850	614197	508315	482996	504960	524764	567146	627134	645568	593769	557813	553618	566533	639082	703320	671428	600826	580656	590783	630468	684061	752929	718542	650468	649084	699824	743218	697544	669660	677373	636635	643583	666256	659891	697581	747270	769612	674185	632614	636975	647749	695622	755680	798055	681642	652490	667474	662257	706064	778580	811112	716759	732210	744089	779877	820744	840217	794598	768120	766658	809470	781076	802449	874828	976366	761946	710110	683852	684678	725234	805441	839699	769510	719993	721788	730960	768952	845521	918987	808679	741267	716522	720515	769884	858983	946893	787695	700728	697902	720724	754243	832699	793762	744802	771500	792502	770020	754359	837340	923309	810641	735095	737604	737002	737110	789691	867132	764991	673958	621756	633220	663847	743680	848815	770926	711249	673244	701748	697160	767145	827465	715329	622372	630468	649652	677629	760111	823386	695332	604014	606858	625562	663490	765850	871500	712988	622205	612297	593440	608535	680774	760590	647049	545956	497600	488445	504035	563262	639447	572641	505848	500423	545593	576868	636008	696388	624523	563494	560240	574271	596934	655651	702046	645207	593317	610492	639237	670621	696648	682122	640323	619053	612253	592169	601651	630468	651132	588761	524137	500087	490015	498983	537900	583788	536302	462855	455662	471532	495567	532946	571221	492101	399058	382481	393007	397634	431068	472977	457364	409116	387404	385437	390085	414396	449366	406684	347852	342840	352711	375270	408526	424183	407370	384192	366164	359554	352536	370627	393741	370048	345330	339618	324177	316338	355142	392216	358104	313852	304323	317819	338058	376695	389066	347114	310646	314325	321432	309017	322867	332716	313852	290129	280594	286930	304366	329610	339548	315218	297273	303193	295682	300044	321310	324864	290565	274702	280797	277677	288326	317582	334100	309966	288511	289033	285295	292046	313859	322504	282226	253205	260296	266387	271777	273381	286716];
#Cheap thrill
#A=[436709	415521	415009	382659	365932	365303	392877	418571	450159	484528	463691	428796	438642	447674	456167	479083	503674	465268	456743	481654	493694	509447	554709	677907	634188	603247	620132	681466	743947	839638	999093	903826	960667	1021038	1024176	1050671	1111326	1190335	1109955	1098860	1106942	1192178	1300018	1372957	1421495	1407312	1389901	1441890	1554326	1710275	1849507	2086314	1939323	1841609	1923256	2073570	2291548	2588837	2655203	2431441	2209519	2262524	2364480	2545936	2675929	2807667	2508495	2707199	3121695	3118795	2854788	2674559	2922220	2671306	2484848	2643881	2614630	2702078	2909036	3142925	2630598	2204319	2125323	2735566	3177391	3479007	3673947	3346504	3212038	3467207	3692425	3860386	4034584	4259438	3723003	3371106	3177158	3401743	3574801	3762101	3940528	3512266	3224757	3330625	3435555	3588887	3732127	3630350	3231173	3293603	3397826	3495946	3528413	3683351	3888352	3477912	3180127	3320272	3388164	3497366	3630882	3772726	3298769	3167050	3188705	3302240	3426354	3591212	3715255	3160706	3331847	3391078	3356811	3570647	3705944	3692425	3860386	4034584	4259438	3723003	3371106	3177158	3401743	3574801	3762101	3940528	3512266	3224757	3330625	3435555	3588887	3732127	3630350	3231173	3293603	3397826	3495946	3528413	3683351	3888352	3477912	3180127	3320272	3388164	3497366	3630882	3772726	3298769	3167050	3188705	3302240	3426354	3591212	3715255	3160706	3331847	3391078	3356811	3570647	3705944	2900417	2922732	3001181	3035043	2727532	2498249	2650141	2642341	2625841	2708552	2826228	2707915	2475380	2593661	2601717	2538852	2559752	2730510	2565101	2384715	2431264	2469293	2469267	2522725	2758931	2639821	2424909	2378381	2456808	2538866	2562342	2870609	2685042	2373574	2275303	2304949	2326721	2399305	2665838	2496281	2224242	2125501	2110163	2123461	2228684	2468766	2285394	2028306	1999467	2050600	2038717	2099347	2305970	2171982	1937995	1851010	1875563	1950820	2147041	2281474	2126965	1881353	1874609	1927915	1957282	2047698	2154688	1989764	1748043	1681198	1711964	1720548	1773701	2021367	1834594	1672472	1658572	1698397	1735044	1831173	2012844	1799578	1599206	1573540	1603906	1627492	1674556	1930968	1734853	1470340	1377756	1407485	1526671	1690273	1882158	1676051	1458907	1408248	1430669	1471371	1568931	1736315	1539253	1348418	1304055	1360898	1397438	1429856	1594681	1418011	1280901	1242360	1277304	1339526	1425958	1482143	1363446	1222985	1241494	1262848	1341889	1429056	1510774	1412112	1272814	1262372	1253515	1256235	1328504	1412822	1278232	1188502	1188158	1212423	1262634	1297208	1372995	1243936	1230971	1261774	1236176	1286372	1412008	1833426	1360298	1167806	1206049	1238527	1282672	1394683	1498347	1339134	1188612	1173149	1226322	1295213	1390585	1540002	1312526	1109934	1106389	1115027	1154961	1210871	1303521	1163286	1061071	1041863	1072695	1084641	1151343	1224563	1046180	928646	1024940	1009520	1008294	1090089	1197099	1048528	971584	1015208	1093064	1160749	1027041	954019	932603	959690	1019385	1097911	1187432	1037036	931092	887908	873635	975582	1084992	1151048	1002765	888155	896328	861642	890390	976742	1069484	929857	827285	827749	837090	843509	950091	1037573	895404	805374	841734	841272	858006	951192	1043728	898221	832368	859927	857812	979275	837375	730917	721129	751098	765019	861212	938966	841616	780889	756044	821247	915996	998581	943569	820422	751400	749871	762944	804864	804689	791781];
#All about that bass
#A=[45848	90405	142856	73843	54828	18645	18386	19578	38554	54643	53470	39707	36607	37562	55734	92054	59130	34220	36929	36875	34858	52140	54708	54982	55623	56993	89472	135446	212405	136754	143946	137228	123822	123949	147146	170146	168514	165007	173018	158415	155601	181809	219026	254770	301213	307302	302071	314437	353890	416829	463321	517121	543649	521048	529490	570875	618977	656992	717776	721746	708480	720075	775591	852249	931299	1003880	1124879	1034148	1093384	1171751	1233331	1331026	1407481	1456656	1467400	1464759	1528954	1611773	1657628	1756425	1815304	1798659	1723259	1660240	1628507	1617319	1991139	2206851	2479107	2108611	1953805	2123615	2272837	2499383	2843630	2509733	2310102	2066113	2090319	2326261	2553113	2927592	2613431	2453577	2241540	2379171	2528827	2788950	3173274	2869258	2686934	2466264	2555900	2738187	3044129	3517893	3116578	2909904	2622968	2783470	3002040	3341726	3922724	3506820	3283884	3054383	3019564	3244544	3502594	3983546	3514484	3252996	3020017	3198343	3460264	3716194	4195128	3753132	3449976	3080232	3294931	3431298	3876810	4375429	3931570	3730591	3305768	3345718	3698177	4088652	4786570	4157910	3820891	3501035	3722781	3538853	4203357	4830202	4209138	3949694	3570530	3779928	4080617	4439092	5009304	4386384	4037565	3762591	4139207	4322472	5008288	4617508	4397549	4085752	3868953	3948253	4120206	4427049	4809535	4173907	3567183	3561087	3450992	3834569	4363631	4046300	3821625	3505926	3271978	3425157	3682077	3859264	4144143	3936367	3902049	4099936	3860112	3797576	3653807	3534046	3398809	3680402	4796588	4145055	4042851	3436102	3833210	3535409	3338015	3297068	3383764	3639227	3954585	4356254	3721270	3423004	3271426	3370925	3603878	3804938	4192213	3631551	3343724	3201394	3284837	3526078	3785923	4128402	3576250	3274451	3245868	3392031	3619033	3794974	4124477	3514187	3211957	3130515	3136078	3346912	3564610	3887644	3399534	3135272	3185501	3289228	3432065	3558291	3770631	3334231	3123728	3082591	3059256	3147312	3451124	3104292	2862570	2587407	2449312	2482626	2610629	2941702	2692581	2544369	2368082	2379309	2480326	2667013	2996377	2766494	2614927	2428863	2360497	2393785	2587508	2703472	2678083	2349246	2716620	2936975	3107409	2966493	2757293	2466946	2179432	2027464	2002345	2075885	2219124	2562072	2337118	2187303	2076139	2117497	2190325	2299063	2348061	2399824	2219418	2156474	2116813	2165192	2317885	2495224	2293086	2133217	2029039	2005510	2086752	2298243	2608011	2343633	2161510	2021068	2021019	2071621	2192851	2368672	2123459	1940376	1854267	1903438	2039243	2134337	2316065	2052776	1897580	1787874	1835837	1927340	2097569	2276536	2072786	1939177	1853672	1891128	1983390	2115651	2281017	2080772	1951626	1869843	1846929	1964915	2090710	2294083	2131431	1978173	1905005	1851990	1918064	2000702	2128411	1906457	1748346	1774617	1837246	1908738	2001838	2059284	1935345	1813321	1785896	1806236	1843247	1923309	2036592	1826315	1701162	1683333	1748607	1810116	1976602	1846183	1818559	1723704	1797577	1776757	1783150	1791335	1738636	1709899	1635197	1655171	1694624	1750722	1781200	1659906	1603311	1568360	1613788	1696682	1858046	2066319	1869782	1803071	1715561	1669737	1650830	1669683	1637897	1577190	1574188	1582110	1622932	1601146	1616408	1616046	1550982	1555793	1558679	1554430	1547271	1582857	1582408	1518199	1491554	1469477	1484530	1460208	1460191	1454717	1390870	1361394	1337004	1372044	1406858	1448308	1470798	1409225	1380897	1384032	1412844	1437277	1465385	1493605	1406900	1376110	1356920	1390707	1385590	1419219	1478992	1457951	1398083	1338879	1357714	1320856	1372469	1500268	1405424	1354265	1256753	1198757	1198676	1288470	1503241	1367303	1262030	1164024	1159651	1222922	1326601	1529110	1382088	1262712	1171324	1173761	1252169	1350548	1500984	1394032	1291645	1172385	1141311	1218706	1317081	1520486	1377640	1280137	1196856	1318278	1532160	1809402	2055706	2226932	1975409	1883251	1867947	1846537	1890806	1991967	1799236	1671524	1570839	1521662	1499532	1556339	1760507	1624167	1552604	1503646	1514807	1599585	1651552	1715774	1603095	1528317	1507051	1541063	1653194	1744357	1903540	1694042	1566908	1442142	1378991	1209892	1377860	1445320	1627945	1401105	1378148	1406503	1365054	1476070	1540806	1683094	1524388	1537228	1596613	1645085	1687376	1619491	1580347	1454102	1365538	1536274	1625346	1710014	1639634	1599875	1564418	1615328	1688107	1815299	1916720	2008008	1738130	1933716	1997534	2110545	1909174	1912442	1821258	1781282	1734482	1797683	1914997	1731993	1680765	1535705	1607869	1673353	1816084	2257754	1904877	1850529	1491498	1527282	1516560	1580138	1578049	1604644	1661944	1646234	1598074	1539932	1562769	1554235	1615813	1712343	1852402	1723858	1648959	1625743	1586646	1622958	1626385	1883570	1763163	1772003	1856812	1900959	1892502	1921111	1794509	1737180	1674945	1730834	1765897	1793597	1812904	1787381	1708176	1612575	1634266	1644819	1681067	1688788	1641357	1516732	1625335	1705258	1675692	1623640	1546870	1410870	1343001	1253180	1274486	1304570	1339706	1395136	1317425	1285269	1219866	1244868	1286558	1335191	1343742	1269811	1219815	1119636	1127615	1159399	1233507	1356364	1261079	1222637	1110698	1135170	1167653	1192609	1237482	1187530	1133865	1093049	1147668	1152549	1140755	1108028	1077992	1059663	1064342	1113940	1148067	1191788	1225031	1279112	1157339	1112240	1093219	1099028	1152447	1343269	1163578	1051661	862457	1062277	1145025	1200875	1214332	1164592	1011650	1113711	1128765	1115615	1144123	1182097	1160472	1134123	1119212	1153233	1181859	1192719	1181657	1158947	1127329	1145128	1158843	1210938	1260373	1292357	1284106	1236754	1206393	1265740	1260946	1300126	1330744	1278989	1220619	1198979	1214255	1259085	1297935	1380055	1301415	1199285	1195612	1214665	1234983	1262599	1369186	1282500	1194027	1156766	1088432	1159370	1041776	850012	668158	385347	518634	792258	1004785	1141345	1173573	1131543	1112027	1073153	1078117	1130933	1163619	1161389	1109214	1100827	1098977	1117723	1132543	1212053	1145646	1096762	1055425	1098470	1124729	1146883	1124097	1082933	1005893	1045550	1079695	1093340	1131386	1153912	1068762	1070177	1104923	1195987	1262423	1259499	1190078	1093009	1069069	1072904	1131221	1116166	1127566	1116976	1059393	1001179	1008501	1050196	1115506	1181195	1296842	1224506	1224267	1272315	1367812	1408392	1458988	1485197	1355614	1323943	1330026	1389326	1423574	1459388	1395552	1314474	1290861	1315125	1393455	1395909	1403570	1392408	1334560	1273665	1260398	1285974	1311277	1287200	1321212	1248101	1237895	1221352	1272652	1324067	1404106	1481740	1499053	1437916	1354136	1305272	1271012	1278478	1334773	1329774	1258447	1200081	1239162	1259407	1251735	1311945	1265630	1212579	1116177	1078327	1085333	1148898	1200745	1200450	1165652	1133420	1146333	1160676	1190091	1228777	1184123	1117960	1063569	1087954	1149136	1269703	1523104	1363822	1281794	1218812	1283060	1352354	1415115	1563949	1452566	1388645	1328341	1338550	1360418	1427365	1519007	1335800	1294561	1241829	1267692	1302469	1361589	1392049	1355504	1293981	1276073	1315879	1382347	1495612	1683763	1490379	1376601	1283044	1299351	1400263	1486503	1607118	1371244	1304246	1316378	1354244	1403154	1471786	1564228	1453828	1374675	1339989	1400133	1453940	1499275	1554425	1455698	1381064	1369558	1407020	1479458	1554676	1651333	1534049	1425694	1413361	1432212	1525377	1647118	1768027	1595219	1496287	1438690	1475538	1545440	1510430	1458938	1425465	1391420	1417160	1487970	1522355	1551673	1459292	1411035	1293820	1516662	1613173	1664457	1806411	1904048	1583746	1318223	1544004	1633262	1691122	1776788	1691284	1646946	1580500	1597168	1624838	1687324	1742943	1760525];

#generate the data of susceptible individuals from A
global Data_Sum
Data_Sum=zeros(1,length(A))
for i=1:length(A)
    Data_Sum[i]=sum(A[1:i])
end

#initial guess
#Caroline
x0=[8	0.4	0.4 3e-06	0.0001]
#Cheap thrill
#x0=[6	0.1	0.1	3e-06	0.0002]
#All about that bass
#x0=[0.03	0.02	0.001	0.0004	0.0003]

res = optimize(ParameterEstimater_SIR,x0)
Optim.minimizer(res)
